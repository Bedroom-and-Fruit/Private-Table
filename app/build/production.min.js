"use strict";$(document).foundation(),function(){Stripe.setPublishableKey("pk_test_rT3gR317GZZ9QOG0D5uMaQWy")}(),angular.module("privateTableApp",["ngAria","ngCookies","ngMessages","ngResource","ngSanitize","ui.router","ngTouch","searchBarFactory","searchResultsFactory","roomFactory","checkoutFactory","angularPayments","mm.foundation","ngModal","authFactory","favoriteFactory","authInterceptorFactory","bookingsFactory"]).config(function(a,b,c,d){b.otherwise("/"),d.interceptors.push("authInterceptor"),a.state("landing",{url:"/",templateUrl:"views/landing.html"}).state("searchBar",{url:"/searchbar?startTimeStamp&endTimeStamp&lng&lat&city&state&country&guests&budget",views:{"":{templateUrl:"views/searchBar.html"},"searchResults@searchBar":{templateUrl:"views/searchBar/searchResults.html",controller:"searchResultsController"}}}).state("bookings",{url:"/bookings",views:{"":{templateUrl:"views/bookings.html"},"searchResults@bookings":{templateUrl:"views/searchBar/searchResults.html",controller:"searchResultsController",authenticate:!0}},authenticate:!0}).state("favorites",{url:"/favorites",templateUrl:"views/favorites.html",controller:"favoritesController",authenticate:!0}).state("checkout",{url:"/checkout","abstract":!0,views:{"":{templateUrl:"views/checkout.html"},"checkoutbox@checkout":{templateUrl:"views/checkout/checkoutbox.html"}}}).state("checkout.room",{url:"/room/:roomID",templateUrl:"views/checkout/room.html"}).state("checkout.menu",{url:"/menu",templateUrl:"views/checkout/menu.html"}).state("checkout.payment",{url:"/payments",templateUrl:"views/checkout/payments.html"}).state("checkout.confirmation",{url:"/confirmation",templateUrl:"views/checkout/confirmation.html"})}).run(function(a,b,c){a.$on("$stateChangeStart",function(d,e){c.isLoggedInAsync(function(c){e.authenticate&&!c&&(a.returnToState=e.url,b.path("/"))})})}),angular.module("privateTableApp").controller("bookingsController",["$scope","Bookings",function(a,b){a.Bookings=b,a.init=function(){b.getAllBookings()},a.init()}]),angular.module("privateTableApp").controller("checkoutController",["$scope","$location","SearchBar","SearchResults","CheckoutOptions","$http","roomData","$stateParams","Auth",function(a,b,c,d,e,f,g,h,i){a.params=c,a.room,a.allBookedTimes,a.eventConfirmed=!1,a.menuConfirmed=!0,a.menuLabel=!0,a.showSummary=!0,a.available=!1,a.menuFinal=!0,a.checkoutMenu=g,a.Auth=i,a.roomData=g,a.toMenu=function(){a.eventConfirmed=!0,a.menuLabel=!1,a.menuConfirmed=!1,$("#roomtab").removeClass("active"),$("#menutab").addClass("active"),g.reroute("/checkout/menu")},a.toRoom=function(){$("#roomtab").addClass("active"),$("#menutab").removeClass("active"),g.reroute("/checkout/room/"+a.room.id)},a.toPay=function(){$(".active").removeClass("active"),b.path("/checkout/payments"),a.menuName=!0,a.menuFinal=!1,a.menuConfirmed=!0,a.showSummary=!1},a.dateInit=function(){c.searchFormInit(),"number"==typeof parseInt(h.roomID)&&g.viewRoom(h.roomID,"api/room/",function(){a.room=g.getRoom(),a.allBookedTimes=g.getAllBookedTimes()},g.reroute("/checkout/room/",h.roomID)),a.room=g.getRoom(),a.allBookedTimes=g.getAllBookedTimes()},a.dateSearch=function(){var b="",c="";b=d.createDate(a.params.searchParams.date,b),c=d.createDate(a.params.searchParams.date,c),b+=" 00:00:00",c+=" 23:59:59",g.findAvailableTimes(a.room.id,"api/dates",b,c,function(){a.allBookedTimes=g.getAllBookedTimes(),a.params.searchParams.endTime&&a.params.searchParams.startTime&&a.checkTime(a.params.searchParams.startTime,a.params.searchParams.endTime)})},a.checkTime=function(b,c){if(b&&c){var e=d.timeConverter(b),f=d.timeConverter(c),g=!1;a.allBookedTimes.forEach(function(a){var b=d.dbTimeConverter(a.start),c=d.dbTimeConverter(a.end);(e>=b&&c>=e||f>=b&&c>=f)&&(g=!0)}),a.available=g}},a.setMinEndTime=function(){var b=c.endTimeAdjuster(a.params.searchParams.startTime);$("#eventend").datetimepicker({datepicker:!1,format:"g:i A",formatTime:"g:i A",step:30,minTime:b})},a.dateInit(),a.Auth.checkLoggedIn()}]),angular.module("privateTableApp").controller("favoritesController",["$scope","Favorites","roomData","Auth","$cookies",function(a,b,c,d,e){a.Favorites=b,a.roomData=c,a.Auth=d,a.viewRoom=function(a){c.viewRoom(a.roomID,"api/room/",null,c.reroute("/checkout/room/",a.roomID))},a.init=function(){b.getFavorites(),d.checkLoggedIn()},a.init()}]),angular.module("privateTableApp").controller("landingController",["$scope","$location","SearchBar","SearchResults","$state",function(a,b,c,d,e){a.params={},a.submitSearch=function(){c.setSearchParams(a.params,d.reroute,"/searchbar")},a.init=function(){c.searchFormInit()},a.setMinEndTime=function(){var b=c.endTimeAdjuster(a.params.startTime);console.log("THIS IS MINEND",b),$("#endtimepick").datetimepicker({datepicker:!1,format:"g:i A",formatTime:"g:i A",step:30,minTime:b}),$("#starttimepick").datetimepicker({datepicker:!1,format:"g:i A",formatTime:"g:i A",step:30,minTime:"12:00 AM"})},a.init()}]),angular.module("privateTableApp").controller("menuController",["$scope","SearchBar","SearchResults","roomData",function(a,b,c,d){a.firstMenu=!0,a.lastMenu=!1,a.menus=d.menus,a.menuNumber=0,a.menuTitle=a.menus[a.menuNumber].name,a.checkoutMenu=d,a.prevMenu=function(){a.menuNumber--,d.viewCourses(a.menus[a.menuNumber].id,function(){a.currentMenu=d.getCurrentMenu(),a.menuTitle=a.menus[a.menuNumber].name,a.lastMenu=!1,0===a.menuNumber&&(a.firstMenu=!0)})},a.nextMenu=function(){a.menuNumber++,d.viewCourses(a.menus[a.menuNumber].id,function(){a.currentMenu=d.getCurrentMenu(),a.menuTitle=a.menus[a.menuNumber].name,a.firstMenu=!1,a.menuNumber===a.menus.length-1&&(a.lastMenu=!0)})},a.chooseMenu=function(){var b=a.menus[a.menuNumber];d.chooseMenu(b)},a.init=function(){a.currentMenu=d.getCurrentMenu()},a.init()}]),angular.module("privateTableApp").controller("paymentsController",["$scope","$location","$state","$http","SearchBar","roomData","SearchResults",function(a,b,c,d,e,f,g){a.roomData=f,a.SearchBar=e,a.SearchResults=g,a.stripeCallback=function(b,h){h.email=a.email;var i=e.searchParams.date,j=g.timeConverter(e.searchParams.startTime),k=g.timeConverter(e.searchParams.endTime),l=g.createDate(i,"")+" "+j+"+00",m=g.createDate(i,"")+" "+k+"+00",n=e.searchParams.guests*f.checkoutMenu.price,o=f.currentRoom.id,p=f.checkoutMenu.id,q=e.searchParams.guests,r=e.searchParams.eventType,s={startTime:l,endTime:m,price:n,roomID:o,menuID:p,guests:q,eventType:r,result:h};if(console.log(s),!h.error){var t="api/payments";return d({method:"POST",url:t,data:s}).then(function(a){c.go("checkout.confirmation")})}window.alert("Your payment did not go through... Try again!")}}]),angular.module("privateTableApp").controller("roomController",["$scope","SearchBar","SearchResults","roomData","$stateParams","$state",function(a,b,c,d,e,f){a.room=d.currentRoom,a.amenityMore=!0,a.feeMore=!0,a.roomID=e,a.SearchBar=b,a.searchParams=b.getSearchParams(),a.feeLimit=4,a.feeMoreClick=function(){this.liftLimit(this.feeLimit,this.fees,"feeMore")},a.toBookings=function(){f.go("bookings")},a.amenityLimit=4,a.amenityMoreClick=function(){this.liftLimit(this.amenityLimit,this.amenities,"amenityMore")},a.liftLimit=function(b,c,d){a[d]=!1},a.init=function(){b.searchFormInit(),"number"==typeof parseInt(e.roomID)&&d.viewRoom(e.roomID,"api/room/",function(){a.room=d.getRoom()},d.reroute("/checkout/room/",e.roomID)),a.room=d.getRoom(),a.searchParams&&a.searchParams.eventType?d.viewMenus(e.roomID,a.searchParams.eventType):d.viewMenus(e.roomID)},a.init()}]),angular.module("privateTableApp").controller("searchBarController",["$scope","$location","SearchBar","SearchResults","$stateParams",function(a,b,c,d,e){a.params,a.newSearch=function(){c.setSearchParams(this.params)},a.init=function(){c.searchFormInit(),e&&d.getResults(e,"api/searchresults"),a.params=c.getSearchParams(),d.showAll()},a.setMinEndTime=function(){var b=c.endTimeAdjuster(a.params.startTime);console.log("THIS IS MINEND",b),$("#endtimepicker").datetimepicker({datepicker:!1,format:"g:i A",formatTime:"g:i A",step:30,minTime:b}),$("#starttimepicker").datetimepicker({datepicker:!1,format:"g:i A",formatTime:"g:i A",step:30,minTime:"12:00 AM"})},a.init()}]),angular.module("privateTableApp").controller("searchResultsController",["$scope","$http","$location","SearchResults","roomData","$cookies","Auth","Favorites","$state",function(a,b,c,d,e,f,g,h,i){a.roomResults=d.searchResults,a.Auth=g,a.Favorites=h,a.bookingType=function(a){return d.bookingsSelection(a)?!0:!1},a.viewRoom=function(a){e.viewRoom(a.roomID,"api/room/",null,e.reroute("/checkout/room/",a.roomID))},a.addFavorite=function(a){h.addFavorite(a.roomID)},a.removeFavorite=function(a){h.removeFavorite(a.roomID)},a.init=function(){g.checkLoggedIn(),a.Auth.loggedIn&&a.Favorites.getFavorites()},a.init()}]),angular.module("privateTableApp").controller("navController",["$scope","$location","SearchBar","Auth","$state","SearchResults",function(a,b,c,d,e,f){a.currentUser,a.Auth=d,a.SearchBar=c,a.$state=e,a.init=function(){a.SearchResults=d.getUser()},a.backToSearch=function(){console.log(c.searchParams),b.path("/searchBar").search(c.searchParams)},a.loginCredentials={},a.errors={},a.loginShown=!1,a.toggleLogin=function(){a.loginShown=!a.loginShown},a.login=function(b){b&&d.login({username:a.loginCredentials.username,password:a.loginCredentials.password}).then(function(){a.currentUser=d.getUser(),a.toggleLogin(),a.Auth.loggedIn=!0})["catch"](function(b){a.errors.other=b.message})},a.signupCredentials={},a.errors={},a.signUpShown=!1,a.toggleSignUp=function(){a.signUpShown=!a.signUpShown},a.signup=function(b){b?d.createUser({username:a.signupCredentials.username,email:a.signupCredentials.email,password:a.signupCredentials.password}).then(function(){a.currentUser=d.getUser(),a.toggleSignUp(),a.Auth.loggedIn=!0})["catch"](function(b){b=b.data,a.errors={}}):console.log("Form is not valid")},a.logout=function(){console.log("logout called"),d.logout(),a.currentUser=d.getUser(),console.log(a.currentUser),b.path("/")},a.init()}]),angular.module("privateTableApp").directive("googleplace",function(){return{require:"ngModel",link:function(a,b,c,d){var e={types:[],componentRestrictions:{}};a.gPlace=new google.maps.places.Autocomplete(b[0],e),google.maps.event.addListener(a.gPlace,"place_changed",function(){a.$apply(function(){d.$setViewValue(b.val())})})}}}),angular.module("authFactory",[]).factory("Auth",["$http","$resource","$cookies","$q",function(a,b,c,d){var e={},f=!1;c.get("PrivateTableToken")&&(e=b("api/users/me").get());var g=function(a){return b("auth/local/").save(a,function(a){c.put("PrivateTableToken",a.token),m.currentUser=b("api/users/me").get()},function(a){console.log(a),console.log("we need to figure out error handling here")}.bind(this)).$promise},h=function(a){var d=b("api/users/");return d.save(a,function(a){c.put("PrivateTableToken",a.token),m.currentUser=b("api/users/me").get()},function(a){console.log(a),console.log("we need to figure out error handling here")}.bind(this)).$promise},i=function(){return m.currentUser},j=function(){c.remove("PrivateTableToken"),m.loggedIn=!1,m.currentUser={}},k=function(a){m.currentUser.hasOwnProperty("$promise")?m.currentUser.$promise.then(function(){a(!0)})["catch"](function(){a(!1)}):a(!1)},l=function(){c.get("PrivateTableToken")&&(m.loggedIn=!0)},m={login:g,logout:j,createUser:h,currentUser:e,getUser:i,isLoggedInAsync:k,loggedIn:f,checkLoggedIn:l};return m}]),angular.module("authInterceptorFactory",[]).factory("authInterceptor",["$rootScope","$cookies","$q","$location",function(a,b,c,d){var e=function(a){return a.headers=a.headers||{},b.get("PrivateTableToken")&&(a.headers.Authorization="Bearer "+b.get("PrivateTableToken")),a},f=function(a){return 401===a.status?(d.path("/login"),b.remove("PrivateTableToken"),c.reject(a)):c.reject(a)};return{request:e,responseError:f}}]),angular.module("bookingsFactory",[]).factory("Bookings",["$http",function(a){var b,c=[],d=function(){var b="/api/users/bookings";a.get(b).success(function(a,b,d,e){console.log(a),c.splice(0,c.length),a.forEach(function(a){c.push(a)})}).error(function(a,b,c,d){console.log(a),console.log("There was an error")})},e={bookings:c,getAllBookings:d,currentBooking:b};return e}]),angular.module("checkoutFactory",[]).factory("CheckoutOptions",["$location",function(a){var b,c={},d=function(a,b){for(var d in a)c[d]=a[d]},e=function(){return c},f=function(a){b=a};return{eventParams:c,getEventParams:e,setEventParams:d,setMenuParams:f}}]),angular.module("favoriteFactory",[]).factory("Favorites",["$location","$http","SearchResults",function(a,b,c){var d=[],e=function(){var a="/api/users/favorites";b.get(a).success(function(a,b,c,e){d.splice(0,d.length),a.forEach(function(a){d.push(a)})}).error(function(a,b,c,d){console.log(a),console.log("There was an error")})},f=function(a){var b=!1;return d.forEach(function(c){c.roomID===a.roomID&&(b=!0)}),b},g=function(a){var c="/api/users/favorites/addfavorites";console.log(a),b.post(c,{roomID:a}).success(function(a,b,c,d){i.getFavorites()}).error(function(a,b,c,d){console.log(a),console.log("There was an error")})},h=function(a){var c="/api/users/favorites/deletefavorites";b.post(c,{roomID:a}).success(function(a,b,c,d){i.getFavorites()}).error(function(a,b,c,d){console.log(a),console.log("There was an error")})},i={favorites:d,removeFavorite:h,addFavorite:g,isFavorite:f,getFavorites:e};return i}]),angular.module("roomFactory",[]).factory("roomData",["SearchResults","$location","$http",function(a,b,c){var d,e,f,g=[],h=[],i={};i.price=0;var j=function(a,b,d,f){var g=b+a;return c({method:"GET",url:g}).then(function(a){e=a.data.id,s.currentRoom=a.data,s.currentRoom.menuPrices=s.currentRoom.menuPrices.sort(function(a,b){return a-b}),d&&d(),f&&f()})},k=function(a,b,d,e,f){var g=b;return c({method:"GET",url:g,params:{roomID:a,startTime:d,endTime:e}}).then(function(a){s.allBookedTimes.splice(0,s.allBookedTimes.length),a.data.allTimeBlocks.forEach(function(a){s.allBookedTimes.push(a)}),f&&f()})},l=function(a,c){c?(b.url(b.path()),b.path(a+c)):b.path(a)},m=function(){return s.currentRoom},n=function(){return s.allBookedTimes},o=function(){return s.currentMenu},p=function(a){s.checkoutMenu=a},q=function(a,b,d){var e="api/menu/eventType";return c({method:"GET",url:e,params:{roomID:a,eventType:b}}).then(function(a){s.menus.splice(0,s.menus.length),a.data.forEach(function(a){s.menus.push(a)}),s.viewCourses(s.menus[0].id),d&&d()})},r=function(a,b){var d="api/menu/menuID?";return c({method:"GET",url:d,params:{menuID:a}}).then(function(a){s.currentMenu=a.data,b&&b()})},s={menus:h,viewCourses:r,viewMenus:q,currentRoom:d,viewRoom:j,getRoom:m,allBookedTimes:g,reroute:l,getAllBookedTimes:n,getCurrentMenu:o,chooseMenu:p,currentMenu:f,findAvailableTimes:k,checkoutMenu:i};return s}]),angular.module("searchBarFactory",[]).factory("SearchBar",["SearchResults","$location","CheckoutOptions","$state",function(a,b,c,d){var e,f=function(b,d,e){j.searchParams=b,c.setEventParams(j.searchParams),d?a.getSearchResults(j.searchParams,d,e):a.getSearchResults(j.searchParams)},g=function(){return j.searchParams},h=function(){$(".timepicker").datetimepicker({datepicker:!1,format:"g:i A",formatTime:"g:i A",step:30}),$("#datepicker").datetimepicker({timepicker:!1,format:"m/d/Y",closeOnDateSelect:!0,minDate:0})},i=function(a,b){b=b?b:1;var c=function(a){a.split(" "),a[1].indexOf("AM")>-1?a[1]="PM":a[1]="AM",a.join(" ")},d=a.split(":");return d[0]=parseInt(d[0])+1,d[0]>12&&(d[0]-=11,d[1]=c(d[1])),12===d[0]&&(d[1]=c(d[1])),d.join(":")},j={endTimeAdjuster:i,searchParams:e,searchFormInit:h,getSearchParams:g,setSearchParams:f};return j}]),angular.module("searchResultsFactory",[]).factory("SearchResults",["$location","$http",function(a,b){var c,d=function(b,c){console.log(b),a.path(c).search(b)},e=[],f=function(a,c,d,f){return b({method:"GET",url:c,params:a}).then(function(b){e.splice(0,e.length),b.data.forEach(function(a){e.push(a)}),d&&d(a,f)})},g=function(a){return f(a,"api/favoriteResults",d,"/favorites")},h=function(a){var b=a.split(" "),c=b[0].split(":"),d=c[1],c=c[0],e=b[1];return e.indexOf("PM")>-1?(c=Number(c),c+=12,24===c&&(c=12)):c.indexOf("12")>-1?c="00":Number(c)<10&&(c="0"+c),c+":"+d+":00"},i=function(a,b){return a=a.split("/"),b+=a[2]+"-"+a[0]+"-"+a[1]},j=function(a,b,c){var d={},e="",g="";if(a.date&&(e=i(a.date,e),g=i(a.date,g)),a.startTime){var j=h(a.startTime);e+=" "+j}if(a.endTime){var k=h(a.endTime);g+=" "+k}e&&(d.startTimeStamp=e),g&&(d.endTimeStamp=g),a.guests&&(d.guests=a.guests),a.budget&&(d.budget=a.budget),a.eventType&&(d.eventType=a.eventType);var l=new google.maps.Geocoder;l.geocode({address:a.location},function(a,e){if(e==google.maps.GeocoderStatus.OK){d.lng=a[0].geometry.location.F,d.lat=a[0].geometry.location.A;for(var g=a[0].address_components,h=0;h<g.length;h++)"locality"===g[h].types[0]&&(d.city=g[h].long_name),"administrative_area_level_1"===g[h].types[0]&&(d.state=g[h].long_name),"country"===g[h].types[0]&&(d.country=g[h].long_name);return f(d,"api/searchresults",b,c)}console.log("No location entered")})},k=function(a){return c&&a.eventType?a.eventType===c?!0:!1:!0},l=function(){c=void 0},m=function(){c="purchased"},n=function(){c="planning"},o=function(a){return a.split("T")[1].split(".")[0]};return{getFavoriteResults:g,searchResults:e,getSearchResults:j,getResults:f,reroute:d,timeConverter:h,bookingsSelection:k,showPlanning:n,showPurchased:m,showAll:l,createDate:i,dbTimeConverter:o}}]);